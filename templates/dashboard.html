<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

    <div class="text-center">
        <h1>Domain and Certificate Expiry Dashboard</h1>
    </div>

    <!-- Form to add new site -->
    <form method="POST" action="{{ url_for('add_site_route') }}">
        <input type="text" name="domain" placeholder="sub.domain.com">
        <input type="submit" value="Add Site">
    </form>

    <!-- Domain columns container -->
    <div class="domain-columns-container">
        {% if sites %}
            {% for main_domain, site_list in sites.items() %}
                <div class="domain-column">
                    <h2>{{ main_domain }}</h2>

                    <!-- WHOIS lease expiry date for main domain -->
                    <div class="lease-expiry">
                        {% if site_list[0]['whois_expiry'] %}
                            {% set whois_color = 'green' if site_list[0]['whois_expiry'] > now + timedelta(days=30) else 'orange' if site_list[0]['whois_expiry'] > now + timedelta(days=7) else 'red' %}
                            <span style="color: lightsteelblue;">
                                Domain Lease Expiry -
                                <span style="color: {{ whois_color }};">{{ site_list[0]['whois_expiry'].strftime('%d %b %Y') }}</span>
                            </span>
                        {% endif %}
                    </div>

                    <!-- Subdomain List (starting from site_list[1:]) -->
                    <ul>
                        {% for site in site_list[1:] %}
                            {% set color = 'green' if site['expiry'] and site['expiry'] > now + timedelta(days=30) else 'orange' if site['expiry'] and site['expiry'] > now + timedelta(days=7) else 'red' %}
                            <li style="color: {{ color }};">
                                <button class="remove-button" onclick="confirmDelete('{{ site['domain'] }}')" title="Delete">üóëÔ∏è</button>

                                <!-- Display expiry date or Unknown if not available -->
                                {% if site['expiry'] %}
                                    <span title="{{ site['expiry'].strftime('%H:%M:%S UTC') }}">
                                        {{ site['expiry'].strftime('%d %b %Y') }}
                                    </span> -
                                {% else %}
                                    <span style="color: red;">Unknown</span> -
                                    <span style="color: red;" title="No certificate info">‚úò</span>
                                {% endif %}

                                <!-- Verification status for each subdomain -->
                                {% if site['verification_status'] == 'green' %}
                                    <span style="color: green" title="Certificate chain verified">‚úî</span>
                                {% elif site['expiry'] and site['verification_status'] == 'red' %}
                                    <!-- Show orange tick if there's a certificate but it's invalid -->
                                    <span style="color: orange" title="Unable to verify certificate (likely missing chain)">‚úî</span>
                                {% endif %}

                                <!-- Subdomain name with link to details -->
                                <a href="{{ url_for('subdomain_detail', subdomain_id=site['id']) }}" style="color: lightsteelblue;">
                                    {{ site['domain'] }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endfor %}
        {% else %}
            <p>No sites added yet.</p>
        {% endif %}
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <span id="modal-text"></span>
            <p>(this action can't be undone)</p>
            <!-- Yes button calls confirmDeletion() -->
            <button id="confirm-yes" onclick="confirmDeletion()">Yes</button>
            <!-- Cancel button calls closeModal() -->
            <button id="confirm-cancel" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script>
        let currentSite = '';

        // Function to open the delete confirmation modal
        function confirmDelete(site) {
            currentSite = site;
            document.getElementById('modal-text').textContent = `Are you sure you want to remove ${site}?`;
            document.getElementById('confirmation-modal').style.display = 'flex';
        }

        // Function to close the modal
        function closeModal() {
            document.getElementById('confirmation-modal').style.display = 'none';
            currentSite = '';
        }

        // Function to confirm deletion and send the POST request to delete the site
        function confirmDeletion() {
            if (currentSite) {
                const cleanedSite = currentSite.replace(/^https?:\/\//, '').replace('/', '').trim();

                fetch(`/delete_site/${encodeURIComponent(cleanedSite)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => {
                    if (response.ok) {
                        window.location.reload();  // Reload the page to reflect changes
                    } else {
                        console.error("Error deleting site:", response.status);
                    }
                }).catch(error => {
                    console.error('Fetch error:', error);
                });
            }
            closeModal();
        }
    </script>

</body>
</html>
